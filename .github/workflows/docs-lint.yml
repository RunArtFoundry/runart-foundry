name: Docs Lint

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'apps/**/docs/**'
      - 'mkdocs.yml'
      - 'tools/lint_docs.*'
      - '*.md'

jobs:
  lint-docs:
    name: Docs Lint
    runs-on: ubuntu-latest
    env:
      MKDOCS_STRICT: "1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MkDocs toolchain
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/briefing/requirements.txt
          if [ -f briefing/requirements.txt ]; then
            pip install -r briefing/requirements.txt
          fi

      - name: Run documentation lint
        id: lint
        run: make lint-docs
        continue-on-error: true

      - name: Upload docs lint log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-lint-log
          path: audits/docs_lint.log

      - name: Publish annotations on failure
        if: steps.lint.outcome == 'failure'
        run: |
          echo "::error::Docs lint falló. Revisa el artifact docs-lint-log para más detalles."
          if [ -f audits/docs_lint.log ]; then
            tail -n 200 audits/docs_lint.log | while IFS= read -r line; do
              echo "::error file=audits/docs_lint.log::${line}"
            done
          fi

      - name: Fail if lint failed
        if: steps.lint.outcome == 'failure'
        run: exit 1
